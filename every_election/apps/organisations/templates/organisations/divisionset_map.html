{% load pipeline %}
{% load static %}

{% block extra_site_css %}
    {% stylesheet 'maplibre-gl' %}
    <style>
        #map-toggle-menu {
            position: absolute;
            z-index: 1;
            top: 10px;
            left: 10px;
            border-radius: 3px;
            width: 100px;
            border: 1px solid rgba(0, 0, 0, 0.4);
            display: none;
        }

        #map-toggle-menu a {
            color: #ffffff;
            display: block;
            padding: 5px;
            text-decoration: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.25);
            text-align: center;
            opacity: 0.6;
            font-weight: normal;
            transition: all 0.2s;
        }

        #map-toggle-menu a:last-child {
            border: none;
        }

        #map-toggle-menu a.active {
            opacity: 1;
            font-weight: bold;
            border: 1px solid #fff;
        }

        #map-toggle-menu a:hover {
            cursor: pointer;
            filter: brightness(1.2);
            text-decoration: underline;
        }

        .map-popup-details {
            line-height: normal;
            padding: 0.5rem;
        }

        .map-popup-details summary {
            margin: 0;
            font-size: 12px;
        }
        .map-popup-details[open] summary {
            margin-bottom: 0;
        }

    </style>
{% endblock extra_site_css %}

{% block extra_site_javascript %}
    <script src="{% static 'maplibre-gl/dist/maplibre-gl.js' %}"></script>
    {% javascript 'pmtiles' %}
{% endblock extra_site_javascript %}

<div >
    <h3>Map</h3>
    <div id="maplibre-gl" class="ds-map-leaflet">
        <nav id="map-toggle-menu"></nav>
    </div>
</div>


{% block in_page_javascript %}
    {{ pmtiles_source_link|json_script:"pmtilesSourceLink" }}
    {{ map_layer_display_name_mapping|json_script:"mapLayerDisplayNameMapping" }}

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const pmtilesSourceLink = JSON.parse(document.getElementById('pmtilesSourceLink').textContent);
            const mapLayerDisplayNameMapping = JSON.parse(document.getElementById('mapLayerDisplayNameMapping').textContent);

            let protocol = new pmtiles.Protocol();
            maplibregl.addProtocol('pmtiles', protocol.tile);
            const PMTILES_URL = pmtilesSourceLink;
            const p = new pmtiles.PMTiles(PMTILES_URL);
            protocol.add(p);




            p.getMetadata().then(data => {
                var style = {
                    "version": 8,
                    "sources": {
                        "os": {
                            "type": "raster",
                            "tiles": [
                                "https://tile.openstreetmap.org/{z}/{x}/{y}.png"
                            ],
                            "tileSize": 256,
                            "attribution": "Â© OpenStreetMap contributors"
                        },
                        "divset": {
                            "type": "vector",
                            "url": "pmtiles://" + p.source.url,
                        }
                    },
                    layers: [
                        {
                            "id": "os-baselayer",
                            "type": "raster",
                            "source": "os",
                            "minzoom": 0,
                            "maxzoom": 19
                        }
                    ]
                }

                const layerColors = {
                    0: "#007CAD",
                    1: "#E6007C",
                }

                data.vector_layers.forEach((layer, layerIdx) => {
                    const layerColor = layerColors[layerIdx];
                    style.layers.push(
                        {
                            "id": `${layer.id}-fill`,
                            "type": "fill",
                            "source": "divset",
                            "source-layer": `${layer.id}`,
                            "paint": {
                                "fill-color": layerColor,
                                "fill-opacity": 0.4
                            }
                        },
                        {
                            "id": `${layer.id}-line`,
                            "type": "line",
                            "source": "divset",
                            "source-layer": `${layer.id}`,
                            "paint": {
                                "line-color": layerColor,
                                "line-width": 2
                            }
                        }
                    )
                });


                const map = new maplibregl.Map({
                    container: 'maplibre-gl',
                    zoom: data.vector_layers[0].maxzoom,
                    style: style,
                });

                map.on('load', function () {

                    const boundsArray = data.antimeridian_adjusted_bounds.split(",").map(coord => parseFloat(coord));
                    map.fitBounds([
                        [boundsArray[0], boundsArray[1]],
                        [boundsArray[2], boundsArray[3]]
                    ], {linear: false, duration: 0, padding: 50})
                });

                function getLayerDisplayName(divisionType) {
                    if (mapLayerDisplayNameMapping[divisionType]) {
                        return mapLayerDisplayNameMapping[divisionType];
                    }
                    return divisionType;
                };

                map.on('idle', () => {
                    // return early if 1 or less layer
                    if (data.vector_layers.length < 2) {
                        return;
                    }
                    // Show the toggle menu
                    document.getElementById('map-toggle-menu').style.display = 'block';

                    const toggleableLayerIds = data.vector_layers.map(layer => layer.id);

                    // Set up toggle button for each layer.
                    toggleableLayerIds.forEach((layerID, layerIDx) => {
                        // Skip layers that already have a button set up.
                        if (document.getElementById(layerID)) {
                            return;
                        }


                        const divisionType = layerID.slice(-3)
                        const linkContent = getLayerDisplayName(divisionType)
                        const layerColor = layerColors[layerIDx]
                        // Create a link.
                        const link = document.createElement('a');
                        link.id = layerID;
                        link.href = '#';
                        link.textContent = linkContent;
                        link.className = layerIDx === 0 ? 'active' : '';
                        link.style.backgroundColor = layerColor;

                        // Set initial visibility: only first layer is visible
                        const fillLayer = `${layerID}-fill`;
                        const lineLayer = `${layerID}-line`;
                        if (layerIDx === 0) {
                            map.setLayoutProperty(fillLayer, 'visibility', 'visible');
                            map.setLayoutProperty(lineLayer, 'visibility', 'visible');
                        } else {
                            map.setLayoutProperty(fillLayer, 'visibility', 'none');
                            map.setLayoutProperty(lineLayer, 'visibility', 'none');
                        }

                        link.onclick = function (e) {
                            const clickedIDFillLayer = `${this.id}-fill`;
                            const clickedIDLineLayer = `${this.id}-line`;
                            e.preventDefault();
                            e.stopPropagation();

                            const fillVisibility = map.getLayoutProperty(clickedIDFillLayer, 'visibility');
                            const lineVisibility = map.getLayoutProperty(clickedIDLineLayer, 'visibility');

                            // Toggle both fill and line layer visibility
                            if (fillVisibility === 'visible' || lineVisibility === 'visible') {
                                map.setLayoutProperty(clickedIDFillLayer, 'visibility', 'none');
                                map.setLayoutProperty(clickedIDLineLayer, 'visibility', 'none');
                                this.className = '';
                            } else {
                                map.setLayoutProperty(clickedIDFillLayer, 'visibility', 'visible');
                                map.setLayoutProperty(clickedIDLineLayer, 'visibility', 'visible');
                                this.className = 'active';
                            }
                        };

                        const toggleMenu = document.getElementById('map-toggle-menu');
                        toggleMenu.appendChild(link);
                    });
                });

                map.on('click', (e) => {
                    const coordinates = e.lngLat;
                    const features = map.queryRenderedFeatures(e.point);

                    if (!features.length) {
                        return;
                    }

                    let featuresData = [];
                    let seen = new Set();

                    for (const feat of features) {
                        const divisionType = feat.layer["source-layer"].slice(-3)
                        const featId = feat.properties.id
                        if (seen.has(featId)) {
                            continue;
                        }
                        featuresData.push({
                            name: feat.properties.name || "Name Missing",
                            officialIdentifier: feat.properties.official_identifier || "",
                            layerColor: feat.layer.paint['fill-color'] || feat.layer.paint['line-color'],
                            layerDisplayName: getLayerDisplayName(divisionType),
                        });
                        seen.add(featId);
                    }

                    let popUpHTML;

                    if (featuresData.length > 1) {
                        popUpHTML = featuresData.map(feat => `
                            <details class="map-popup-details" >
                                <summary style="color: ${feat.layerColor};">${feat.layerDisplayName}</summary><br />
                                <strong>${feat.name}</strong><br />
                                ${feat.officialIdentifier}<br />
                            </details>
                            `).join('');
                    } else {
                        const feat = featuresData[0]
                        popUpHTML = `
                            <div>
                                <strong>${feat.name}</strong><br />
                                ${feat.officialIdentifier}<br />
                            </div>
                        `
                    }

                    new maplibregl.Popup({ closeButton: true, closeOnClick: true })
                        .setLngLat(coordinates)
                        .setHTML(popUpHTML)
                        .addTo(map);
                });

                data.vector_layers.forEach(layer => {

                    map.on('mouseenter', `${layer.id}-fill`, () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });

                    map.on('mouseleave', `${layer.id}-fill`, () => {
                        map.getCanvas().style.cursor = '';
                    });
                });


                map.addControl(new maplibregl.NavigationControl(), 'top-right');

            });
        });
    </script>
{% endblock in_page_javascript %}